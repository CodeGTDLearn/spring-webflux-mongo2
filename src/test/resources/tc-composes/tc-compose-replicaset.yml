version: "3.4"

networks:
  app_net:
    driver: bridge

services:
  api-db-tc:
    image: mongo:4.0.10
    ports:
      - 27017:27017
    restart: always
    environment:
      - MONGO_INITDB_ROOT_USERNAME=root
      - MONGO_INITDB_ROOT_PASSWORD=root
      - MONGO_AUTH_DB=admin
    #    command: "mongod --bind_ip_all --replSet rs0"
    #    command: "mongod --port 27017 --dbpath /srv/mongodb/db0 --replSet rs0 --bind_ip_all"
    healthcheck:
      test: >
        $${MONGO_INITDB_DATABASE}
        $$(echo "rs.initiate().ok || rs.status().ok || rs.secondaryOk()" |
        mongo
        -u $${MONGO_INITDB_ROOT_USERNAME}
        -p $${MONGO_INITDB_ROOT_PASSWORD}
        --authenticationDatabase $${MONGO_AUTH_DB}
        --quiet) -eq 1
      interval: 10s
      start_period: 30s
    #    entrypoint: [ "bash", "-c", "chmod +x /resources/rs-init-test.sh && sh/resources/rs-init-test.sh"]
    networks:
      - app_net
#    https://stackoverflow.com/questions/33366182/how-to-set-rs-slaveok-in-secondary-mongodb-servers-in-replicaset-via-commandli

#    command: mongod --replSet docker-rs --port 9042
#      - MONGO_REPLICA_SET_NAME=rs0
#      - MONGO_INITDB_DATABASE=api-db-tc
#      - SPRING_DATA_MONGODB_URI=mongodb://root:root@rs0:27017/api-db-tc?replicaSet=rs0&authSource=admin
#  mongodb://mongodb1.example.com:27317,mongodb2.example.com:27017/?replicaSet=mySet&authSource=authDB
#  mongodb://user1:user1@localhost:26000/love?authSource=love&readPreference=primary&appname=MongoDB%20Compass&ssl=false
#      https://stackoverflow.com/questions/69767291/testcontainers-dockercomposecontainer-withenvjava.lang